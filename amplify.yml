# Configuración de AWS Amplify optimizada para VeraSalud
# Incluye optimizaciones específicas para sitios médicos de Next.js
# Garantiza despliegue rápido y confiable para pacientes

version: 1

# Variables de entorno para optimización médica
env:
  variables:
    # Configuración para máximo rendimiento en producción
    NODE_ENV: production
    NEXT_TELEMETRY_DISABLED: 1
    
    # Configuración específica para sitio médico
    SITE_NAME: VeraSalud
    SITE_TYPE: medical_clinic
    LOCATION: Cali_Colombia
    
    # Optimizaciones de memoria para compilación
    NODE_OPTIONS: '--max_old_space_size=4096'

# Configuración de compilación optimizada para sitios médicos
frontend:
  phases:
    # Fase de pre-compilación: instalación optimizada de dependencias
    preBuild:
      commands:
        # Limpia cache para garantizar compilación limpia
        - echo "Iniciando compilación optimizada para VeraSalud..."
        - npm ci --production=false --silent
        
        # Verifica integridad de dependencias médicas críticas
        - echo "Verificando dependencias críticas..."
        - npm audit --audit-level=high
        
        # Configura variables para optimización médica
        - echo "Configurando optimizaciones para sitio médico..."
        - export NODE_ENV=production
        
    # Fase de compilación: construcción optimizada del sitio médico
    build:
      commands:
        # Compila sitio con optimizaciones máximas
        - echo "Compilando sitio médico VeraSalud con optimizaciones avanzadas..."
        - npm run build
        
        # Verifica que archivos críticos médicos se generaron correctamente
        - echo "Verificando archivos críticos del sitio médico..."
        - ls -la .next/
        - ls -la public/
        
        # Optimiza archivos estáticos para velocidad médica
        - echo "Optimizando recursos estáticos para carga rápida..."
        
    # Fase de post-compilación: optimizaciones finales
    postBuild:
      commands:
        # Genera reportes de optimización
        - echo "Generando reportes de rendimiento para sitio médico..."
        
        # Verifica optimizaciones críticas para sitios médicos
        - echo "Verificando optimizaciones de velocidad implementadas..."
        
        # Confirma preparación para pacientes
        - echo "Sitio médico VeraSalud listo para servir pacientes!"

  # Configuración de artefactos para sitio médico optimizado
  artifacts:
    # Archivos base del sitio médico compilado
    baseDirectory: .next
    files:
      - '**/*'
    
    # Excluye archivos innecesarios para optimizar transferencia
    exclude:
      - node_modules/**/*
      - .git/**/*
      - .env.local
      - .env.development
      - '**/*.test.js'
      - '**/*.spec.js'
      - coverage/**/*

  # Configuración de cache para compilaciones rápidas
  cache:
    paths:
      # Cache de dependencias para compilaciones más rápidas
      - node_modules/**/*
      - .next/cache/**/*
      
      # Cache específico para optimización médica
      - .next/static/**/*

# Configuración de headers personalizados para sitio médico
customHeaders:
  # Headers para todas las páginas médicas
  - pattern: '**/*'
    headers:
      # Seguridad médica avanzada
      - key: 'Strict-Transport-Security'
        value: 'max-age=31536000; includeSubDomains; preload'
      
      # Optimización de cache para recursos médicos
      - key: 'X-Frame-Options'
        value: 'DENY'
      
      # Política de contenido para sitios médicos
      - key: 'Content-Security-Policy'
        value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://www.google-analytics.com;"
  
  # Headers específicos para recursos estáticos médicos
  - pattern: '/static/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000, immutable'
  
  # Headers para imágenes médicas
  - pattern: '/images/**'
    headers:
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'

# Configuración de redirects para SEO médico
redirects:
  # Redirects para URLs médicas comunes
  - source: '/medicina-interna'
    target: '/#servicios'
    status: '301'
  
  - source: '/ecografias'
    target: '/#servicios'
    status: '301'
  
  - source: '/contacto'
    target: '/#contacto'
    status: '301'
  
  - source: '/citas'
    target: '/#contacto'
    status: '301'